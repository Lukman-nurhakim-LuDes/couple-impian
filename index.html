<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couple GrowUp - Petualangan Menuju Impian</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            /* Menggunakan font 'Carton' dan sans-serif sebagai cadangan */
            /* Catatan: Font 'Carton' harus diimpor atau disediakan sebagai font kustom agar berfungsi */
            font-family: 'Carton', sans-serif; 
            background-color: #f0f2f5; /* Light gray fallback background */
            background-image: url('icons/Background.jpg'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat; 
            background-attachment: fixed; 
        }
        /* Mengatur ukuran font untuk h1 dan h2 secara eksplisit menjadi 24px */
        /* Mengurangi ukuran font untuk h1 di header */
        h1 {
            font-size: 25px !important; /* Memperkecil ukuran font untuk judul utama */
        }
        h2 {
            font-size: 24px !important; /* Menggunakan !important untuk menimpa Tailwind */
        }
        /* Mengatur latar belakang kartu menjadi transparan dan tanpa bayangan */
        .card {
            background-color: transparent; /* Latar belakang transparan */
            box-shadow: none; /* Tanpa bayangan */
            border-radius: 1.25rem; 
            transition: transform 0.2s ease-in-out;
            cursor: pointer; 
            padding: 0.5rem; 
            /* text-align: center; (akan di-override oleh text-left/right di HTML) */
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .icon-placeholder {
            background-color: transparent; 
            border-radius: 0.75rem; 
            display: flex;
            align-items: center;
            /* justify-content: center; (akan di-override oleh justify-start/end di HTML) */
            color: #4b5563;
            font-weight: 600;
            /* text-align: center; (akan di-override oleh text-left/right in HTML) */
            padding: 0; 
        }
        .icon-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain; 
        }
        /* Styles for the custom modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1.25rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            text-align: center;
            position: relative;
        }
        .modal-close-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4b5563;
        }
        /* Active state for footer navigation */
        .footer-nav-item.active {
            color: #4f46e5; /* Tailwind indigo-600 */
            font-weight: 700;
        }
        /* Hidden class for pages */
        .hidden-page {
            display: none !important; 
        }
        /* Calendar specific styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            width: 100%;
            max-width: 600px;
        }
        .calendar-day {
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #e0e7ff; 
            text-align: center;
            font-weight: 600;
            color: #4338ca; 
        }
        .calendar-date {
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #f0f2f5;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-date:hover {
            background-color: #e2e8f0;
        }
        .calendar-date.has-event {
            background-color: #93c5fd; 
            color: #1e40af; 
            font-weight: 700;
        }
        .calendar-header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: #374151;
        }
        .calendar-header button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4f46e5;
        }
        /* Habits progress bar */
        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 1rem;
            background-color: #4CAF50; 
            width: 0%;
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
        }

        /* Pic Drop specific styles for camera effect */
        .camera-frame {
            position: relative;
            width: 200px; 
            height: 150px; 
            background-image: url('icons/polaroi.png'); /* Menggunakan gambar polaroi.png */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-end; 
            overflow: hidden; 
        }

        .polaroid-photo {
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 10px;
            text-align: center;
            transform: translateY(100%); 
            animation: slideOut 0.5s forwards; 
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%); 
            width: 80%; 
            max-width: 120px; 
            border-radius: 5px;
        }

        .polaroid-photo img {
            width: 100%;
            height: auto;
            display: block;
            margin-bottom: 5px;
            border-radius: 3px;
        }

        @keyframes slideOut {
            from {
                transform: translateX(-50%) translateY(100%);
            }
            to {
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-2 sm:p-4 lg:p-8">

    <!-- Header Section -->
    <header class="w-full max-w-4xl bg-transparent p-3 sm:p-5 rounded-2xl shadow-none flex justify-between items-center mb-4">
        <!-- Icon Aku -->
        <div class="flex items-center">
            <!-- Menggunakan jalur lokal untuk aku.png dan ukuran 100px -->
            <img src="icons/aku.png" alt="Aku Icon" class="w-[100px] h-[100px] rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/100x100/d1d5db/4b5563?text=Aku';">
        </div>
        
        <div class="text-center">
            <h1 class="font-bold text-indigo-700">Couple GrowUp</h1>
            <p class="text-sm sm:text-base text-gray-600 mt-0.5">Petualangan Menuju Impian</p>
        </div>
        
        <!-- Icon Kamu (Now represents the user's profile) -->
        <div class="flex items-center">
            <!-- Menggunakan jalur lokal untuk kamu.png dan ukuran 100px -->
            <img id="header-user-profile-pic" src="icons/kamu.png" alt="Kamu Icon" class="w-[100px] h-[100px] rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/100x100/d1d5db/4b5563?text=Kamu';">
        </div>
    </header>

    <!-- Main Content Area (Home Page) -->
    <main id="home-page" class="w-full max-w-4xl">

        <!-- Monitor Event (Central Board-like Card) -->
        <div id="monitor-event-card" class="card w-full p-4 mt-8 flex flex-col justify-center items-center" style="background-image: url('icons/Monitor-event.png'); background-size: contain; background-repeat: no-repeat; background-position: center; min-height: 150px;">
            <h2 class="font-bold text-gray-800 mb-1">Monitor Event</h2>
            <div id="monitor-event-content" class="text-xs text-gray-600 text-center mt-4"> <!-- Mengubah ukuran teks dan rata tengah -->
                <!-- Konten akan diisi secara dinamis -->
            </div>
        </div>

        <!-- Feature Cards Row 1 -->
        <div class="flex w-full justify-between mt-4 px-2">
            <!-- Keuangan Card -->
            <div id="keuangan-card" class="card flex flex-col items-start w-1/2 pr-1"> 
                <div class="icon-placeholder w-20 h-20 sm:w-24 sm:h-24 mb-0.5 justify-start"> <!-- Memperbesar ukuran ikon dan mengatur perataan ikon ke kiri -->
                    <img src="icons/keuangan.png" alt="Keuangan Icon" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/64x64/d1d5db/4b5563?text=Keuangan';">
                </div>
                <h2 class="font-semibold text-gray-800 text-left">Keuangan</h2>
            </div>
            <!-- Game Card (Removed) -->
        </div>

        <!-- Feature Cards Row 2 -->
        <div class="flex w-full justify-between mt-3 px-2">
            <!-- Tabungan Card -->
            <div id="tabungan-card" class="card flex flex-col items-start w-1/2 pr-1"> <!-- Mengatur perataan teks ke kiri -->
                <div class="icon-placeholder w-20 h-20 sm:w-24 sm:h-24 mb-0.5 justify-start"> <!-- Memperbesar ukuran ikon dan mengatur perataan ikon ke kiri -->
                    <img src="icons/Tabungan.png" alt="Tabungan Icon" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/64x64/d1d5db/4b5563?text=Tabungan';">
                </div>
                <h2 class="font-semibold text-gray-800 text-left">Tabungan</h2>
            </div>
            <!-- Pasangan Card (Now Profile Card) -->
            <div id="profile-card" class="card flex flex-col items-end w-1/2 pl-1"> <!-- Mengatur perataan teks ke kanan -->
                <div class="icon-placeholder w-20 h-20 sm:w-24 sm:h-24 mb-0.5 justify-end"> <!-- Memperbesar ukuran ikon dan mengatur perataan ikon ke kanan -->
                    <img src="icons/pasangan.png" alt="Profil Icon" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/64x64/d1d5db/4b5563?text=Profil';">
                </div>
                <h2 class="font-semibold text-gray-800 text-right">Profil</h2>
            </div>
        </div>
    </main>

    <!-- Authentication Page -->
    <div id="auth-page" class="hidden-page w-full max-w-md p-6 sm:p-8 bg-white rounded-2xl shadow-md mb-8 flex flex-col items-center text-center">
        <h2 class="font-bold text-indigo-700 mb-4" id="auth-title">Login</h2>
        <p class="text-base sm:text-lg text-gray-700 mb-6" id="auth-subtitle">Masuk untuk melanjutkan petualangan Anda!</p>
        
        <div class="w-full space-y-4">
            <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="auth-submit-btn" class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">Login</button>
            <button id="auth-toggle-btn" class="w-full px-6 py-3 bg-gray-300 text-gray-800 rounded-lg shadow hover:bg-gray-400 transition-colors">Belum punya akun? Register</button>
        </div>
    </div>


    <!-- Keuangan Page -->
    <div id="keuangan-page" class="hidden-page w-full max-w-4xl p-6 sm:p-8 bg-white rounded-2xl shadow-md mb-8 flex flex-col items-center text-center">
        <h2 class="font-bold text-indigo-700 mb-4">Atur Pemasukan & Pengeluaran</h2>
        <p class="text-base sm:text-lg text-gray-700 mb-6">Kelola keuangan Anda dengan mudah di sini. Tambahkan pemasukan dan catat setiap pengeluaran.</p>
        
        <!-- Income and Expense Input Forms -->
        <div class="w-full max-w-md space-y-4">
            <div class="flex flex-col items-start w-full">
                <label for="income-amount" class="text-gray-700 text-sm font-medium mb-1">Jumlah Pemasukan:</label>
                <input type="number" id="income-amount" placeholder="Masukkan jumlah pemasukan" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <label for="income-desc" class="text-gray-700 text-sm font-medium mb-1 mt-2">Deskripsi Pemasukan:</label>
                <input type="text" id="income-desc" placeholder="Contoh: Gaji bulanan" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="add-income-btn" class="mt-4 w-full px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-colors">Tambah Pemasukan</button>
            </div>

            <div class="flex flex-col items-start w-full">
                <label for="expense-amount" class="text-gray-700 text-sm font-medium mb-1">Jumlah Pengeluaran:</label>
                <input type="number" id="expense-amount" placeholder="Masukkan jumlah pengeluaran" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <label for="expense-desc" class="text-gray-700 text-sm font-medium mb-1 mt-2">Deskripsi Pengeluaran:</label>
                <input type="text" id="expense-desc" placeholder="Contoh: Belanja kebutuhan" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="add-expense-btn" class="mt-4 w-full px-6 py-3 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition-colors">Tambah Pengeluaran</button>
            </div>
        </div>

        <h3 class="font-bold text-gray-800 mt-8 mb-4">Ringkasan Keuangan</h3>
        <div class="w-full max-w-md bg-gray-100 p-4 rounded-lg text-left">
            <p class="text-gray-700 text-lg">Total Pemasukan: <span id="total-income" class="font-semibold text-green-700">Rp 0</span></p>
            <p class="text-gray-700 text-lg">Total Pengeluaran: <span id="total-expense" class="font-semibold text-red-700">Rp 0</span></p>
            <p class="text-gray-800 text-xl mt-2">Saldo Bersih: <span id="net-balance" class="font-bold text-indigo-700">Rp 0</span></p>
        </div>

        <h3 class="font-bold text-gray-800 mt-8 mb-4">Riwayat Transaksi</h3>
        <div id="transaction-history" class="w-full max-w-md bg-gray-100 p-4 rounded-lg text-left overflow-y-auto max-h-60">
            <!-- Transaction items will be appended here -->
            <p class="text-gray-500">Belum ada transaksi.</p>
        </div>

        <button onclick="window.showPage('home-page')" class="mt-8 px-6 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">Kembali ke Beranda</button>
    </div>

    <!-- Tabungan Page -->
    <div id="tabungan-page" class="hidden-page w-full max-w-4xl p-6 sm:p-8 bg-white rounded-2xl shadow-md mb-8 flex flex-col items-center text-center">
        <h2 class="font-bold text-indigo-700 mb-4">Atur Tabungan</h2>
        <p class="text-base sm:text-lg text-gray-700 mb-6">Kelola tujuan tabungan Anda di sini. Tambahkan tujuan, pantau progres, dan catat setiap setoran.</p>
        
        <!-- Savings Goal Input Forms -->
        <div class="w-full max-w-md space-y-4">
            <div class="flex flex-col items-start w-full">
                <label for="saving-goal-name" class="text-gray-700 text-sm font-medium mb-1">Nama Tujuan Tabungan:</label>
                <input type="text" id="saving-goal-name" placeholder="Contoh: Liburan impian" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <label for="saving-goal-amount" class="text-gray-700 text-sm font-medium mb-1 mt-2">Target Jumlah Tabungan:</label>
                <input type="number" id="saving-goal-amount" placeholder="Masukkan target jumlah" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="add-saving-goal-btn" class="mt-4 w-full px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">Tambah Tujuan Tabungan</button>
            </div>
        </div>

        <h3 class="font-bold text-gray-800 mt-8 mb-4">Daftar Tujuan Tabungan</h3>
        <div id="saving-goals-list" class="w-full max-w-md bg-gray-100 p-4 rounded-lg text-left overflow-y-auto max-h-60">
            <p class="text-gray-500">Belum ada tujuan tabungan.</p>
        </div>

        <button onclick="window.showPage('home-page')" class="mt-8 px-6 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">Kembali ke Beranda</button>
    </div>

    <!-- Profile Page (formerly Pasangan Page) -->
    <div id="profile-page" class="hidden-page w-full max-w-4xl p-6 sm:p-8 bg-white rounded-2xl shadow-md mb-8 flex flex-col items-center text-center">
        <h2 class="font-bold text-indigo-700 mb-4">Profil Saya</h2>
        <p class="text-base sm:text-lg text-gray-700 mb-6">Kelola informasi profil Anda di sini.</p>
        
        <div class="w-full max-w-md space-y-4">
            <h3 class="font-bold text-gray-800">Informasi Profil</h3>
            <div class="flex flex-col items-center space-y-2">
                <img id="user-profile-pic" src="icons/kamu.png" alt="Profil Saya" class="w-24 h-24 rounded-full object-cover border-2 border-indigo-500" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e0e7ff/4338ca?text=Saya';">
                <input type="file" id="user-profile-pic-upload" accept="image/*" class="hidden">
                <button id="change-user-pic-btn" class="text-sm text-blue-600 hover:underline mt-1">Ubah Foto</button>
                <input type="text" id="user-nickname-input" placeholder="Nama Panggilan Saya" class="w-full p-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 mt-2">
                <button id="save-user-nickname-btn" class="w-full px-4 py-2 bg-indigo-500 text-white rounded-lg shadow hover:bg-indigo-600 transition-colors">Simpan Nama Panggilan</button>
                <div class="user-id-container flex items-center text-sm text-gray-600"> <!-- Always visible, show user's own ID -->
                    User ID: <span id="user-id-display" class="font-mono text-gray-800 ml-1">Loading...</span>
                    <button id="toggle-user-id-btn" class="ml-2 px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded-md">Tampilkan/Sembunyikan ID</button>
                </div>
                <button id="logout-button" class="mt-4 px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition-colors">Logout</button>
            </div>
        </div>

        <button onclick="window.showPage('home-page')" class="mt-8 px-6 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">Kembali ke Beranda</button>
    </div>

    <!-- Dashboard Page -->
    <div id="dasbor-page" class="hidden-page w-full max-w-4xl p-6 sm:p-8 bg-white rounded-2xl shadow-md mb-8 flex flex-col items-center text-center">
        <h2 class="font-bold text-indigo-700 mb-4">Dasbor Anda</h2>
        <p class="text-base sm:text-lg text-gray-700 mb-6">Selamat datang di Dasbor Anda! Ini adalah ringkasan aktivitas dan progres Anda.</p>
        
        <div class="w-full max-w-2xl grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            <!-- Scorecards -->
            <div class="bg-blue-100 p-4 rounded-lg shadow text-left">
                <h3 class="font-semibold text-blue-800 text-lg mb-2">Ringkasan Keuangan</h3>
                <p class="text-gray-700">Pemasukan: <span id="dashboard-income" class="font-bold text-green-700">Rp 0</span></p>
                <p class="text-gray-700">Pengeluaran: <span id="dashboard-expense" class="font-bold text-red-700">Rp 0</span></p>
                <p class="text-gray-800 text-xl mt-2">Saldo: <span id="dashboard-balance" class="font-bold text-indigo-700">Rp 0</span></p>
            </div>
            <div class="bg-green-100 p-4 rounded-lg shadow text-left">
                <h3 class="font-semibold text-green-800 text-lg mb-2">Progres Tabungan</h3>
                <p class="text-gray-700">Tujuan Aktif: <span id="dashboard-saving-goals" class="font-bold">0</span></p>
                <p class="text-700">Total Target: <span id="dashboard-total-saving-target" class="font-bold">Rp 0</span></p>
            </div>
            <div class="bg-purple-100 p-4 rounded-lg shadow text-left">
                <h3 class="font-semibold text-purple-800 text-lg mb-2">Progres Kebiasaan</h3>
                <p class="text-gray-700">Kebiasaan Aktif: <span id="dashboard-active-habits" class="font-bold">0</span></p>
                <p class="text-gray-700">Selesai Hari Ini: <span id="dashboard-completed-habits" class="font-bold">0</span></p>
            </div>
            <div class="bg-yellow-100 p-4 rounded-lg shadow text-left">
                <h3 class="font-semibold text-yellow-800 text-lg mb-2">Wishlist</h3>
                <p class="text-gray-700">Item Aktif: <span id="dashboard-active-wishlist" class="font-bold">0</span></p>
                <p class="text-gray-700">Item Terpenuhi: <span id="dashboard-fulfilled-wishlist" class="font-bold">0</span></p>
            </div>
        </div>

        <h3 class="font-bold text-gray-800 mt-8 mb-4">Grafik Keuangan</h3>
        <div class="w-full max-w-md bg-gray-100 p-4 rounded-lg text-center">
            <canvas id="financeLineChart"></canvas>
        </div>
        <div class="w-full max-w-md bg-gray-100 p-4 rounded-lg text-center mt-6">
            <canvas id="expensePieChart"></canvas>
        </div>

        <button onclick="window.showPage('home-page')" class="mt-8 px-6 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">Kembali ke Beranda</button>
    </div>

    <!-- Calendar Page -->
    <div id="kalender-page" class="hidden-page w-full max-w-4xl p-6 sm:p-8 bg-white rounded-2xl shadow-md mb-8 flex flex-col items-center text-center">
        <h2 class="font-bold text-indigo-700 mb-4">Kalender Event</h2>
        <p class="text-base sm:text-lg text-gray-700 mb-6">Atur jadwal dan event penting Anda di sini.</p>
        
        <div class="w-full max-w-md">
            <div class="calendar-header">
                <button id="prev-month-btn">&lt;</button>
                <span id="current-month-year"></span>
                <button id="next-month-btn">&gt;</button>
            </div>
            <div id="calendar-grid" class="calendar-grid">
                <!-- Days of the week -->
                <div class="calendar-day">Min</div>
                <div class="calendar-day">Sen</div>
                <div class="calendar-day">Sel</div>
                <div class="calendar-day">Rab</div>
                <div class="calendar-day">Kam</div>
                <div class="calendar-day">Jum</div>
                <div class="calendar-day">Sab</div>
                <!-- Dates will be populated here by JS -->
            </div>
        </div>

        <h3 class="font-bold text-gray-800 mt-8 mb-4">Tambah Event Baru</h3>
        <div class="w-full max-w-md space-y-4">
            <div class="flex flex-col items-start w-full">
                <label for="event-date" class="text-gray-700 text-sm font-medium mb-1">Tanggal Event:</label>
                <input type="date" id="event-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <label for="event-name" class="text-gray-700 text-sm font-medium mb-1 mt-2">Nama Event:</label>
                <input type="text" id="event-name" placeholder="Contoh: Kencan malam" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <label for="event-description" class="text-gray-700 text-sm font-medium mb-1 mt-2">Deskripsi Event (Opsional):</label>
                <textarea id="event-description" placeholder="Detail event..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 h-24"></textarea>
                <button id="add-event-btn" class="mt-4 w-full px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">Tambah Event</button>
            </div>
        </div>

        <h3 class="font-bold text-gray-800 mt-8 mb-4">Daftar Event</h3>
        <div id="event-list" class="w-full max-w-md bg-gray-100 p-4 rounded-lg text-left overflow-y-auto max-h-60">
            <p class="text-gray-500">Belum ada event.</p>
        </div>

        <button onclick="window.showPage('home-page')" class="mt-8 px-6 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">Kembali ke Beranda</button>
    </div>

    <!-- Habits Page -->
    <div id="habits-page" class="hidden-page w-full max-w-4xl p-6 sm:p-8 bg-white rounded-2xl shadow-md mb-8 flex flex-col items-center text-center">
        <h2 class="font-bold text-indigo-700 mb-4">Lacak Kebiasaan</h2>
        <p class="text-base sm:text-lg text-gray-700 mb-6">Lacak kebiasaan baik Anda untuk pertumbuhan diri.</p>
        
        <div class="w-full max-w-md space-y-4">
            <div class="flex flex-col items-start w-full">
                <label for="habit-name" class="text-gray-700 text-sm font-medium mb-1">Nama Kebiasaan Baru:</label>
                <input type="text" id="habit-name" placeholder="Contoh: Olahraga pagi" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="add-habit-btn" class="mt-4 w-full px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-colors">Tambah Kebiasaan</button>
            </div>
        </div>

        <h3 class="font-bold text-gray-800 mt-8 mb-4">Daftar Kebiasaan</h3>
        <div class="w-full max-w-2xl bg-gray-100 p-4 rounded-lg text-left overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kebiasaan</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progres</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Selesai Hari Ini</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="habits-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Habits will be populated here -->
                    <tr>
                        <td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Belum ada kebiasaan.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button onclick="window.showPage('home-page')" class="mt-8 px-6 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">Kembali ke Beranda</button>
    </div>

    <!-- Pic Drop Page -->
    <div id="picdrop-page" class="hidden-page w-full max-w-4xl p-6 sm:p-8 bg-white rounded-2xl shadow-md mb-8 flex flex-col items-center text-center">
        <h2 class="font-bold text-indigo-700 mb-4">Pic Drop</h2>
        <p class="text-base sm:text-lg text-gray-700 mb-6">Bagikan momen indah Anda dengan Pic Drop. (Fungsionalitas upload foto ke server tidak tersedia dalam demo ini).</p>
        
        <div class="w-full max-w-md space-y-4 flex flex-col items-center">
            <!-- Camera Frame for Photo Output -->
            <div id="camera-output-frame" class="camera-frame">
                <!-- Polaroid photo will be inserted here dynamically -->
            </div>

            <div class="flex flex-col items-start w-full">
                <label for="photo-caption" class="text-gray-700 text-sm font-medium mb-1">Keterangan Foto:</label>
                <input type="text" id="photo-caption" placeholder="Contoh: Kamera Upload Polaroid" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                <button id="select-photo-btn" class="mt-4 w-full px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">Pilih Foto</button>
                <button id="upload-photo-btn" class="mt-2 w-full px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-colors hidden">Unggah Foto (Simulasi)</button>
            </div>
        </div>

        <h3 class="font-bold text-gray-800 mt-8 mb-4">Galeri Foto</h3>
        <div id="photo-gallery" class="w-full max-w-2xl grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 bg-gray-100 p-4 rounded-lg text-left overflow-y-auto max-h-96">
            <!-- Photos will be populated here -->
            <p class="col-span-full text-gray-500 text-center">Belum ada foto.</p>
        </div>

        <button onclick="window.showPage('home-page')" class="mt-8 px-6 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">Kembali ke Beranda</button>
    </div>

    <!-- Wishlist Page -->
    <div id="wishlist-page" class="hidden-page w-full max-w-4xl p-6 sm:p-8 bg-white rounded-2xl shadow-md mb-8 flex flex-col items-center text-center">
        <h2 class="font-bold text-indigo-700 mb-4">Daftar Keinginan</h2>
        <p class="text-base sm:text-lg text-gray-700 mb-6">Buat daftar keinginan Anda untuk masa depan.</p>
        
        <div class="w-full max-w-md space-y-4">
            <div class="flex flex-col items-start w-full">
                <label for="wishlist-item-name" class="text-gray-700 text-sm font-medium mb-1">Nama Item:</label>
                <input type="text" id="wishlist-item-name" placeholder="Contoh: Tiket konser" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <label for="wishlist-item-price" class="text-gray-700 text-sm font-medium mb-1 mt-2">Perkiraan Harga (Opsional):</label>
                <input type="number" id="wishlist-item-price" placeholder="Contoh: 500000" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="add-wishlist-item-btn" class="mt-4 w-full px-6 py-3 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 transition-colors">Tambah Item</button>
            </div>
        </div>

        <h3 class="font-bold text-gray-800 mt-8 mb-4">Daftar Item</h3>
        <div id="wishlist-items-list" class="w-full max-w-md bg-gray-100 p-4 rounded-lg text-left overflow-y-auto max-h-60">
            <p class="text-gray-500">Belum ada item di daftar keinginan.</p>
        </div>

        <button onclick="window.showPage('home-page')" class="mt-8 px-6 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">Kembali ke Beranda</button>
    </div>

    <!-- Footer Navigation -->
    <footer id="main-footer" class="w-full max-w-4xl bg-transparent p-3 sm:p-5 rounded-2xl shadow-none flex justify-around items-center">
        <!-- Dasbor Card -->
        <div id="dasbor-nav" class="footer-nav-item flex flex-col items-center text-center cursor-pointer active">
            <div class="icon-placeholder w-12 h-12 sm:w-14 sm:h-14 mb-0.5">
                <img src="icons/Dasbor.png" alt="Dasbor Icon" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/48x48/d1d5db/4b5563?text=Dasbor';">
            </div>
            <p class="text-xs sm:text-sm text-gray-700">Dasbor</p>
        </div>
        <!-- Kalender Card -->
        <div id="kalender-nav" class="footer-nav-item flex flex-col items-center text-center cursor-pointer">
            <div class="icon-placeholder w-12 h-12 sm:w-14 sm:h-14 mb-0.5">
                <img src="icons/Kalender.png" alt="Kalender Icon" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/48x48/d1d5db/4b5563?text=Kalender';">
            </div>
            <p class="text-xs sm:text-sm text-gray-700">Kalender</p>
        </div>
        <!-- Habits Card -->
        <div id="habits-nav" class="footer-nav-item flex flex-col items-center text-center cursor-pointer">
            <div class="icon-placeholder w-12 h-12 sm:w-14 sm:h-14 mb-0.5">
                <img src="icons/Habits.png" alt="Habits Icon" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/48x48/d1d5db/4b5563?text=Habits';">
            </div>
            <p class="text-xs sm:text-sm text-gray-700">Habits</p>
        </div>
        <!-- Pic Drop Card -->
        <div id="picdrop-nav" class="footer-nav-item flex flex-col items-center text-center cursor-pointer">
            <div class="icon-placeholder w-12 h-12 sm:w-14 sm:h-14 mb-0.5">
                <img src="icons/pic drop.png" alt="Pic Drop Icon" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/48x48/d1d5db/4b5563?text=Pic+Drop';">
            </div>
            <p class="text-xs sm:text-sm text-gray-700">Pic Drop</p>
        </div>
        <!-- Wishlist Card -->
        <div id="wishlist-nav" class="footer-nav-item flex flex-col items-center text-center cursor-pointer">
            <div class="icon-placeholder w-12 h-12 sm:w-14 sm:h-14 mb-0.5">
                <img src="icons/Wishlist.png" alt="Wishlist Icon" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/48x48/d1d5db/4b5563?text=Wishlist';">
            </div>
            <p class="text-xs sm:text-sm text-gray-700">Wishlist</p>
        </div>
    </footer>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="window.closeModal()">&times;</button>
            <p id="modal-message" class="text-lg text-gray-800"></p>
        </div>
    </div>

    <!-- Service Worker Registration -->
    <script>
        // Global functions for modal (accessible from HTML onclick)
        window.showModal = function(message) {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('custom-modal').classList.add('show');
        }

        window.closeModal = function() {
            document.getElementById('custom-modal').classList.remove('show');
        }
    </script>
    
    <!-- Main application logic with Firebase imports -->
    <script type="module">
        // Firebase Configuration (from your input)
        const firebaseConfig = {
            apiKey: "AIzaSyBJvImC_0c11FAXRmDRLkEAMGC1tXdj5ns",
            authDomain: "couplegrowup.firebaseapp.com",
            projectId: "couplegrowup",
            storageBucket: "couplegrowup.firebasestorage.app",
            messagingSenderId: "566350672167",
            appId: "1:566350672167:web:357408665e9cc3ddfeb902"
        };
        // Global variables for Firebase instances
        let app;
        let db;
        let auth;
        let userId;
        let isAuthReady = false; // Flag to ensure auth is ready before Firestore ops
        let unsubscribeEvents = null; // Unsubscribe for events listener
        let unsubscribeWishlist = null; // Unsubscribe for wishlist listener
        let unsubscribeTransactions = null; // Unsubscribe for transactions listener
        let unsubscribeSavingGoals = null; // Unsubscribe for saving goals listener
        let unsubscribeHabits = null; // Unsubscribe for habits listener
        let unsubscribeUserProfile = null; // Unsubscribe for user profile listener

        // Chart.js instances
        let financeLineChart = null;
        let expensePieChart = null;

        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, deleteDoc, doc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Get main page elements
        const homePage = document.getElementById('home-page');
        const mainFooter = document.getElementById('main-footer'); // Get the footer element

        // Get feature pages
        const keuanganPage = document.getElementById('keuangan-page');
        const tabunganPage = document.getElementById('tabungan-page');
        const profilePage = document.getElementById('profile-page'); // Renamed from pasanganPage
        const dasborPage = document.getElementById('dasbor-page');
        const kalenderPage = document.getElementById('kalender-page');
        const habitsPage = document.getElementById('habits-page');
        const picdropPage = document.getElementById('picdrop-page');
        const wishlistPage = document.getElementById('wishlist-page');
        const authPage = document.getElementById('auth-page'); // Authentication Page

        // Get feature cards (top section)
        const keuanganCard = document.getElementById('keuangan-card');
        const tabunganCard = document.getElementById('tabungan-card'); 
        const profileCard = document.getElementById('profile-card'); // Renamed from pasanganCard

        // Get Monitor Event elements (static on home page)
        const monitorEventTitle = document.getElementById('monitor-event-title'); // This element doesn't exist in HTML, but keeping it for consistency if it was intended.
        const monitorEventContent = document.getElementById('monitor-event-content');

        // Get footer navigation items
        const footerNavItems = document.querySelectorAll('.footer-nav-item');

        // Get Keuangan page elements
        const incomeAmountInput = document.getElementById('income-amount');
        const incomeDescInput = document.getElementById('income-desc');
        const addIncomeBtn = document.getElementById('add-income-btn');
        const expenseAmountInput = document.getElementById('expense-amount');
        const expenseDescInput = document.getElementById('expense-desc');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const totalIncomeSpan = document.getElementById('total-income');
        const totalExpenseSpan = document.getElementById('total-expense');
        const netBalanceSpan = document.getElementById('net-balance');
        const transactionHistoryDiv = document.getElementById('transaction-history');

        let totalIncome = 0;
        let totalExpense = 0;
        let transactions = []; // This will now be populated by Firestore listener

        // Get Tabungan page elements
        const savingGoalNameInput = document.getElementById('saving-goal-name');
        const savingGoalAmountInput = document.getElementById('saving-goal-amount');
        const addSavingGoalBtn = document.getElementById('add-saving-goal-btn');
        const savingGoalsListDiv = document.getElementById('saving-goals-list');

        let savingGoals = []; // This will now be populated by Firestore listener

        // Get Kalender page elements
        const currentMonthYearSpan = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const calendarGrid = document.getElementById('calendar-grid');
        const eventDateInput = document.getElementById('event-date');
        const eventNameInput = document.getElementById('event-name'); // Corrected typo
        const eventDescriptionInput = document.getElementById('event-description');
        const addEventBtn = document.getElementById('add-event-btn');
        const eventListDiv = document.getElementById('event-list');

        let currentCalendarDate = new Date();
        let events = []; // This will be populated by Firestore listener

        // Get Habits page elements
        const habitNameInput = document.getElementById('habit-name');
        const addHabitBtn = document.getElementById('add-habit-btn'); 
        const habitsTableBody = document.getElementById('habits-table-body');

        let habits = []; // This will be populated by Firestore listener

        // Get Pic Drop page elements
        const photoCaptionInput = document.getElementById('photo-caption');
        const photoUploadInput = document.getElementById('photo-upload-input');
        const selectPhotoBtn = document.getElementById('select-photo-btn');
        const uploadPhotoBtn = document.getElementById('upload-photo-btn');
        const photoGalleryDiv = document.getElementById('photo-gallery');
        const cameraOutputFrame = document.getElementById('camera-output-frame'); // New element for camera output

        let uploadedPhotos = []; // This will store simulated photo data (client-side only for this demo)

        // Get Wishlist page elements
        const wishlistItemNameInput = document.getElementById('wishlist-item-name');
        const wishlistItemPriceInput = document.getElementById('wishlist-item-price');
        const addWishlistItemBtn = document.getElementById('add-wishlist-item-btn');
        const wishlistItemsListDiv = document.getElementById('wishlist-items-list');

        let wishlistItems = []; // This will be populated by Firestore listener

        // Get Dashboard elements
        const dashboardIncomeSpan = document.getElementById('dashboard-income');
        const dashboardExpenseSpan = document.getElementById('dashboard-expense');
        const dashboardBalanceSpan = document.getElementById('dashboard-balance');
        const dashboardSavingGoalsSpan = document.getElementById('dashboard-saving-goals');
        const dashboardTotalSavingTargetSpan = document.getElementById('dashboard-total-saving-target');
        const dashboardActiveHabitsSpan = document.getElementById('dashboard-active-habits');
        const dashboardCompletedHabitsSpan = document.getElementById('dashboard-completed-habits');
        const dashboardActiveWishlistSpan = document.getElementById('dashboard-active-wishlist');
        const dashboardFulfilledWishlistSpan = document.getElementById('dashboard-fulfilled-wishlist');

        // Get Auth page elements
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleBtn = document.getElementById('auth-toggle-btn');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const logoutButton = document.getElementById('logout-button');

        let isLoginMode = true; // State for login/register form

        // Get Profile page elements (formerly Pasangan page)
        const userProfilePic = document.getElementById('user-profile-pic'); // Renamed from partnerProfilePic
        const userProfilePicUpload = document.getElementById('user-profile-pic-upload'); // Renamed
        const changeUserPicBtn = document.getElementById('change-user-pic-btn'); // Renamed
        const userNicknameInput = document.getElementById('user-nickname-input'); // Renamed from partnerNicknameInput
        const saveUserNicknameBtn = document.getElementById('save-user-nickname-btn'); // Renamed from savePartnerNicknameBtn
        const userIdDisplaySpan = document.getElementById('user-id-display'); // Renamed from partnerUserIdSpan
        const toggleUserIdBtn = document.getElementById('toggle-user-id-btn'); 
        const userIdDisplayContainer = document.querySelector('#profile-page .user-id-container'); // Updated selector
        const headerUserProfilePic = document.getElementById('header-user-profile-pic'); // Added for header icon


        // Initialize Firebase and set up authentication
        window.addEventListener('DOMContentLoaded', async () => {
            console.log("DOMContentLoaded fired. Initializing Firebase...");
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for auth state changes to get userId and initialize Firestore listeners
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // If user is anonymous, force them to login/register
                        if (user.isAnonymous) {
                            console.log("Anonymous user detected, forcing login/registration.");
                            await signOut(auth); // Sign out anonymous user
                            userId = null;
                            isAuthReady = false;
                            if (userIdDisplayContainer) { 
                                userIdDisplayContainer.classList.add('hidden');
                            }
                            logoutButton.classList.add('hidden');
                            window.showPage('auth-page');
                            return; // Stop further execution for anonymous users
                        }

                        // For authenticated (non-anonymous) users
                        userId = user.uid;
                        if (userIdDisplaySpan) { 
                            userIdDisplaySpan.textContent = userId;
                        }
                        // User ID display is now always hidden by default, can be toggled
                        if (userIdDisplayContainer) {
                            userIdDisplayContainer.classList.add('hidden');
                        }

                        isAuthReady = true;
                        logoutButton.classList.remove('hidden'); // Show logout button
                        console.log("Firebase initialized and user authenticated:", userId);

                        // Setup Firestore listeners after authentication
                        setupFirestoreListeners();
                        window.showPage('home-page'); // Show home page after successful login
                    } else {
                        // No user (or signed out anonymous user)
                        userId = null;
                        if (userIdDisplaySpan) { 
                            userIdDisplaySpan.textContent = 'Not Authenticated';
                        }
                        if (userIdDisplayContainer) {
                            userIdDisplayContainer.classList.add('hidden');
                        }
                        isAuthReady = false;
                        logoutButton.classList.add('hidden'); // Hide logout button
                        console.log("User not authenticated.");
                        window.showPage('auth-page'); // Show login page if not authenticated
                        // Unsubscribe from all listeners if user logs out
                        if (unsubscribeEvents) { unsubscribeEvents(); unsubscribeEvents = null; }
                        if (unsubscribeWishlist) { unsubscribeWishlist(); unsubscribeWishlist = null; }
                        if (unsubscribeTransactions) { unsubscribeTransactions(); unsubscribeTransactions = null; }
                        if (unsubscribeSavingGoals) { unsubscribeSavingGoals(); unsubscribeSavingGoals = null; }
                        if (unsubscribeHabits) { unsubscribeHabits(); unsubscribeHabits = null; }
                        if (unsubscribeUserProfile) { unsubscribeUserProfile(); unsubscribeUserProfile = null; }
                    }
                });

                // Initial authentication attempt (if no token, will fall back to anonymous)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token.");
                    } catch (customTokenError) {
                        console.warn("Custom token sign-in failed, letting onAuthStateChanged handle it:", customTokenError);
                        // Do not signInAnonymously here, let onAuthStateChanged redirect to auth-page if not a proper user
                    }
                } else {
                    // No custom token, onAuthStateChanged will handle the unauthenticated state
                    console.log("No custom token provided, letting onAuthStateChanged handle initial state.");
                }

            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                if (userIdDisplaySpan) { 
                    userIdDisplaySpan.textContent = 'Error loading user ID';
                }
                if (userIdDisplayContainer) {
                    userIdDisplayContainer.classList.add('hidden');
                }
                window.showModal('Terjadi kesalahan saat memuat aplikasi. Mohon coba lagi.');
                window.showPage('auth-page'); // Fallback to auth page on init error
            }
        });

        // Function to set up Firestore listeners
        function setupFirestoreListeners() {
            if (!isAuthReady || !userId) {
                console.warn("Firebase not ready or userId not available for Firestore listeners.");
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // All data is now private to the user
            const getCollectionPath = (baseCollection) => {
                return `artifacts/${appId}/users/${userId}/${baseCollection}`;
            };

            // Unsubscribe existing listeners before setting up new ones
            if (unsubscribeTransactions) { unsubscribeTransactions(); }
            if (unsubscribeSavingGoals) { unsubscribeSavingGoals(); }
            if (unsubscribeEvents) { unsubscribeEvents(); }
            if (unsubscribeHabits) { unsubscribeHabits(); }
            if (unsubscribeWishlist) { unsubscribeWishlist(); }
            if (unsubscribeUserProfile) { unsubscribeUserProfile(); }

            // Firestore listener for Transactions (Keuangan)
            unsubscribeTransactions = onSnapshot(query(collection(db, getCollectionPath('transactions'))), (snapshot) => {
                transactions = [];
                snapshot.forEach(doc => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                updateFinancialSummary();
                renderTransactionHistory();
                updateDashboardFinance(); // Update dashboard
                updateFinanceCharts(); // Update charts
            }, (error) => {
                console.error("Error fetching transactions:", error);
                window.showModal('Gagal memuat data transaksi. Silakan coba lagi.');
            });

            // Firestore listener for Saving Goals (Tabungan)
            unsubscribeSavingGoals = onSnapshot(query(collection(db, getCollectionPath('savingGoals'))), (snapshot) => {
                savingGoals = [];
                snapshot.forEach(doc => {
                    savingGoals.push({ id: doc.id, ...doc.data() });
                });
                renderSavingGoals();
                updateDashboardSavings(); // Update dashboard
            }, (error) => {
                console.error("Error fetching saving goals:", error);
                window.showModal('Gagal memuat data tujuan tabungan. Silakan coba lagi.');
            });

            // Firestore listener for Events (Kalender)
            unsubscribeEvents = onSnapshot(query(collection(db, getCollectionPath('events'))), (snapshot) => {
                events = [];
                snapshot.forEach(doc => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                renderCalendar();
                renderEventList();
                updateMonitorEventContentFromData(); // Update monitor event
            }, (error) => {
                console.error("Error fetching events:", error);
                window.showModal('Gagal memuat data event. Silakan coba lagi.');
            });

            // Firestore listener for Habits
            unsubscribeHabits = onSnapshot(query(collection(db, getCollectionPath('habits'))), (snapshot) => {
                habits = [];
                snapshot.forEach(doc => {
                    habits.push({ id: doc.id, ...doc.data() });
                });
                renderHabitsTable();
                updateDashboardHabits(); // Update dashboard
            }, (error) => {
                console.error("Error fetching habits:", error);
                window.showModal('Gagal memuat data kebiasaan. Silakan coba lagi.');
            });

            // Firestore listener for Wishlist
            unsubscribeWishlist = onSnapshot(query(collection(db, getCollectionPath('wishlist'))), (snapshot) => {
                wishlistItems = [];
                snapshot.forEach(doc => {
                    wishlistItems.push({ id: doc.id, ...doc.data() });
                });
                renderWishlistItems();
                updateDashboardWishlist(); // Update dashboard
                updateMonitorEventContentFromData(); // Update monitor event
            }, (error) => {
                console.error("Error fetching wishlist items:", error);
                window.showModal('Gagal memuat daftar keinginan. Silakan coba lagi.');
            });

            // Listener for user's own profile (always private)
            unsubscribeUserProfile = onSnapshot(doc(db, `artifacts/${appId}/users/${userId}/profile/data`), (docSnap) => {
                if (docSnap.exists()) {
                    const profileData = docSnap.data();
                    userNicknameInput.value = profileData.nickname || '';
                    if (profileData.profilePicUrl) {
                        userProfilePic.src = profileData.profilePicUrl;
                        headerUserProfilePic.src = profileData.profilePicUrl; // Update header icon
                    } else {
                        userProfilePic.src = 'icons/kamu.png'; // Default if no custom pic
                        headerUserProfilePic.src = 'icons/kamu.png'; // Default if no custom pic
                    }
                } else {
                    // Profile document doesn't exist, initialize default values
                    userNicknameInput.value = '';
                    userProfilePic.src = 'icons/kamu.png';
                    headerUserProfilePic.src = 'icons/kamu.png';
                }
            }, (error) => {
                console.error("Error fetching user profile:", error);
                window.showModal('Gagal memuat profil pengguna. Silakan coba lagi.');
            });
        }

        // Function to show a specific page and hide others, and manage footer visibility
        window.showPage = function(pageId) {
            console.log("Navigating to page:", pageId);
            // Hide all main content areas
            homePage.classList.add('hidden-page');
            keuanganPage.classList.add('hidden-page');
            tabunganPage.classList.add('hidden-page');
            profilePage.classList.add('hidden-page'); // Renamed
            dasborPage.classList.add('hidden-page');
            kalenderPage.classList.add('hidden-page');
            habitsPage.classList.add('hidden-page');
            picdropPage.classList.add('hidden-page');
            wishlistPage.classList.add('hidden-page');
            authPage.classList.add('hidden-page'); // Hide auth page

            mainFooter.classList.add('hidden-page'); // Hide the footer by default

            // Show the requested page
            const pageToShow = document.getElementById(pageId);
            if (pageToShow) {
                pageToShow.classList.remove('hidden-page');
            } else {
                console.error("Page not found:", pageId);
            }

            // Manage footer visibility and active state
            if (pageId === 'home-page' || pageId === 'dasbor-page' || pageId === 'kalender-page' || pageId === 'habits-page' || pageId === 'picdrop-page' || pageId === 'wishlist-page') {
                mainFooter.classList.remove('hidden-page'); // Show footer for these pages
                footerNavItems.forEach(item => item.classList.remove('active'));
                const activeNavItem = document.getElementById(`${pageId.replace('-page', '')}-nav`);
                if (activeNavItem) {
                    activeNavItem.classList.add('active');
                }
            } else {
                mainFooter.classList.add('hidden-page'); // Hide footer for other pages
            }

            // Special handling for auth page: hide user ID and logout button
            if (pageId === 'auth-page') {
                if (userIdDisplayContainer) {
                    userIdDisplayContainer.classList.add('hidden');
                }
                logoutButton.classList.add('hidden');
            } else {
                // User ID display is now always hidden by default, only logout button visibility depends on auth state
                if (auth.currentUser) {
                    logoutButton.classList.remove('hidden');
                }
            }
        }

        // Event Listeners for Main Feature Cards (top section)
        keuanganCard.addEventListener('click', () => {
            console.log("Keuangan card clicked.");
            if (!isAuthReady) { window.showModal('Mohon login terlebih dahulu.'); return; }
            window.showPage('keuangan-page');
        });

        tabunganCard.addEventListener('click', () => {
            console.log("Tabungan card clicked.");
            if (!isAuthReady) { window.showModal('Mohon login terlebih dahulu.'); return; }
            window.showPage('tabungan-page');
        });

        profileCard.addEventListener('click', () => { // Renamed from pasanganCard
            console.log("Profile card clicked.");
            if (!isAuthReady) { window.showModal('Mohon login terlebih dahulu.'); return; }
            window.showPage('profile-page'); // Renamed from pasangan-page
        });

        // Function to update main content (Monitor Event) - now only used for initial load or if explicitly needed
        // Updated to display real-time data from events and wishlist
        function updateMonitorEventContentFromData() {
            let content = '';
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const todayFormatted = today.toISOString().split('T')[0];
            const tomorrowFormatted = tomorrow.toISOString().split('T')[0];

            // Upcoming events
            const upcomingEvents = events.filter(event => new Date(event.date) >= today).sort((a, b) => new Date(a.date) - new Date(b.date));
            if (upcomingEvents.length > 0) {
                content += 'Event Mendatang:<br>';
                upcomingEvents.slice(0, 3).forEach(event => { // Show up to 3 upcoming events
                    content += ` ${event.name} (${new Date(event.date).toLocaleDateString('id-ID')})<br>`;
                });
                if (upcomingEvents.length > 3) {
                    content += `... dan ${upcomingEvents.length - 3} lainnya.<br>`;
                }
            }

            // Unfulfilled wishlist items
            const unfulfilledWishlist = wishlistItems.filter(item => !item.fulfilled);
            if (unfulfilledWishlist.length > 0) {
                if (content !== '') content += '<br>'; // Add a line break if there are events
                content += 'Wishlist Belum Terpenuhi:<br>';
                unfulfilledWishlist.slice(0, 3).forEach(item => { // Show up to 3 unfulfilled items
                    content += ` ${item.name}${item.price ? ` (${formatCurrency(item.price)})` : ''}<br>`;
                });
                if (unfulfilledWishlist.length > 3) {
                    content += `... dan ${unfulfilledWishlist.length - 3} lainnya.<br>`;
                }
            }

            if (content === '') {
                content = 'Belum ada aktivitas atau keinginan yang perlu dimonitor.';
            }
            monitorEventContent.innerHTML = content;
        }


        // --- Keuangan Feature Logic ---
        function formatCurrency(amount) {
            return `Rp ${new Intl.NumberFormat('id-ID').format(amount)}`;
        }

        function updateFinancialSummary() {
            totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const netBalance = totalIncome - totalExpense;

            totalIncomeSpan.textContent = formatCurrency(totalIncome);
            totalExpenseSpan.textContent = formatCurrency(totalExpense);
            netBalanceSpan.textContent = formatCurrency(netBalance);

            // Set color for net balance
            if (netBalance < 0) {
                netBalanceSpan.classList.remove('text-indigo-700');
                netBalanceSpan.classList.add('text-red-700');
            } else {
                netBalanceSpan.classList.remove('text-red-700');
                netBalanceSpan.classList.add('text-indigo-700');
            }
        }

        function renderTransactionHistory() {
            transactionHistoryDiv.innerHTML = ''; // Clear previous entries
            if (transactions.length === 0) {
                transactionHistoryDiv.innerHTML = '<p class="text-gray-500">Belum ada transaksi.</p>';
                return;
            }

            // Sort transactions by date descending
            const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedTransactions.forEach((t, index) => {
                const transactionItem = document.createElement('div');
                transactionItem.classList.add('flex', 'justify-between', 'items-center', 'py-2', 'border-b', 'border-gray-200');
                if (index === sortedTransactions.length - 1) {
                    transactionItem.classList.remove('border-b'); // Remove border for the last item
                }

                const amountClass = t.type === 'income' ? 'text-green-600' : 'text-red-600';
                const sign = t.type === 'income' ? '+' : '-';

                transactionItem.innerHTML = `
                    <div class="flex flex-col items-start">
                        <span class="font-medium text-gray-800">${t.description}</span>
                        <span class="text-xs text-gray-500">${new Date(t.date).toLocaleDateString('id-ID')}</span>
                    </div>
                    <button class="text-red-500 hover:text-red-700 text-sm" onclick="window.deleteTransaction('${t.id}')">Hapus</button>
                    <span class="font-semibold ${amountClass}">${sign} ${formatCurrency(t.amount)}</span>
                `;
                transactionHistoryDiv.appendChild(transactionItem);
            });
        }

        addIncomeBtn.addEventListener('click', async () => {
            console.log("Add Income button clicked.");
            const amount = parseFloat(incomeAmountInput.value);
            const description = incomeDescInput.value.trim();

            if (isNaN(amount) || amount <= 0 || !description) {
                window.showModal('Mohon masukkan jumlah dan deskripsi pemasukan yang valid.');
                return;
            }
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap. Mohon tunggu atau coba lagi.');
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), { // Changed path
                    type: 'income',
                    amount: amount,
                    description: description,
                    date: new Date().toISOString()
                });
                incomeAmountInput.value = '';
                incomeDescInput.value = '';
            } catch (e) {
                console.error("Error adding income document: ", e);
                window.showModal('Gagal menambahkan pemasukan. Silakan coba lagi.');
            }
        });

        addExpenseBtn.addEventListener('click', async () => {
            console.log("Add Expense button clicked.");
            const amount = parseFloat(expenseAmountInput.value);
            const description = expenseDescInput.value.trim();

            if (isNaN(amount) || amount <= 0 || !description) {
                window.showModal('Mohon masukkan jumlah dan deskripsi pengeluaran yang valid.');
                return;
            }
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap. Mohon tunggu atau coba lagi.');
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), { // Changed path
                    type: 'expense',
                    amount: amount,
                    description: description,
                    date: new Date().toISOString()
                });
                expenseAmountInput.value = '';
                expenseDescInput.value = '';
            } catch (e) {
                console.error("Error adding expense document: ", e);
                window.showModal('Gagal menambahkan pengeluaran. Silakan coba lagi.');
            }
        });

        window.deleteTransaction = async function(transactionId) {
            console.log("Delete Transaction clicked:", transactionId);
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap atau Anda tidak memiliki izin.');
                return;
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, transactionId)); // Changed path
            } catch (e) {
                console.error("Error deleting transaction: ", e);
                window.showModal('Gagal menghapus transaksi. Silakan coba lagi.');
            }
        }

        // --- Chart Logic ---
        function updateFinanceCharts() {
            const dates = [...new Set(transactions.map(t => new Date(t.date).toLocaleDateString('id-ID')))].sort((a, b) => new Date(a) - new Date(b));
            const incomeData = dates.map(date => transactions.filter(t => t.type === 'income' && new Date(t.date).toLocaleDateString('id-ID') === date).reduce((sum, t) => sum + t.amount, 0));
            const expenseData = dates.map(date => transactions.filter(t => t.type === 'expense' && new Date(t.date).toLocaleDateString('id-ID') === date).reduce((sum, t) => sum + t.amount, 0));

            // Line Chart for Income vs Expense
            const lineCtx = document.getElementById('financeLineChart').getContext('2d');
            if (financeLineChart) {
                financeLineChart.destroy();
            }
            financeLineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: incomeData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Pengeluaran',
                            data: expenseData,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Pie Chart for Expense Distribution (simplified, just showing total expense for now)
            const expenseCategories = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                const category = t.description || 'Lain-lain'; // Use description as a simple category
                expenseCategories[category] = (expenseCategories[category] || 0) + t.amount;
            });

            const pieLabels = Object.keys(expenseCategories);
            const pieData = Object.values(expenseCategories);
            const backgroundColors = pieLabels.map((_, i) => `hsl(${i * 60}, 70%, 50%)`); // Generate distinct colors

            const pieCtx = document.getElementById('expensePieChart').getContext('2d');
            if (expensePieChart) {
                expensePieChart.destroy();
            }
            expensePieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: pieLabels,
                    datasets: [{
                        data: pieData,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Pengeluaran'
                        }
                    }
                }
            });
        }


        // --- Tabungan Feature Logic ---
        function renderSavingGoals() {
            savingGoalsListDiv.innerHTML = ''; // Clear previous entries
            if (savingGoals.length === 0) {
                savingGoalsListDiv.innerHTML = '<p class="text-gray-500">Belum ada tujuan tabungan.</p>';
                return;
            }

            savingGoals.forEach((goal) => {
                const goalItem = document.createElement('div');
                goalItem.classList.add('flex', 'justify-between', 'items-center', 'py-2', 'border-b', 'border-gray-200');
                
                goalItem.innerHTML = `
                    <div class="flex flex-col items-start">
                        <span class="font-medium text-gray-800">${goal.name}</span>
                        <span class="text-xs text-gray-500">Target: ${formatCurrency(goal.targetAmount)}</span>
                    </div>
                    <button class="text-red-500 hover:text-red-700 text-sm" onclick="window.deleteSavingGoal('${goal.id}')">Hapus</button>
                `;
                savingGoalsListDiv.appendChild(goalItem);
            });
        }

        window.deleteSavingGoal = async function(goalId) {
            console.log("Delete Saving Goal clicked:", goalId);
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap atau Anda tidak memiliki izin.');
                return;
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/savingGoals`, goalId)); // Changed path
            } catch (e) {
                console.error("Error deleting saving goal: ", e);
                window.showModal('Gagal menghapus tujuan tabungan. Silakan coba lagi.');
            }
        }

        addSavingGoalBtn.addEventListener('click', async () => {
            console.log("Add Saving Goal button clicked.");
            const name = savingGoalNameInput.value.trim();
            const targetAmount = parseFloat(savingGoalAmountInput.value);

            if (!name || isNaN(targetAmount) || targetAmount <= 0) {
                window.showModal('Mohon masukkan nama dan target jumlah tabungan yang valid.');
                return;
            }
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap. Mohon tunggu atau coba lagi.');
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/savingGoals`), { // Changed path
                    name: name,
                    targetAmount: targetAmount,
                    currentAmount: 0, // Start with 0 current amount
                    createdAt: new Date().toISOString()
                });
                savingGoalNameInput.value = '';
                savingGoalAmountInput.value = '';
            } catch (e) {
                console.error("Error adding saving goal: ", e);
                window.showModal('Gagal menambahkan tujuan tabungan. Silakan coba lagi.');
            }
        });

        // --- Calendar Feature Logic ---
        function renderCalendar() {
            calendarGrid.innerHTML = ''; // Clear existing calendar
            currentMonthYearSpan.textContent = currentCalendarDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' });

            // Add day names
            const dayNames = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            dayNames.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day');
                dayDiv.textContent = day;
                calendarGrid.appendChild(dayDiv);
            });

            const firstDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const numDaysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

            // Add empty divs for days before the 1st of the month
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDiv = document.createElement('div');
                calendarGrid.appendChild(emptyDiv);
            }

            // Add days of the month
            for (let day = 1; day <= numDaysInMonth; day++) {
                const dateDiv = document.createElement('div');
                dateDiv.classList.add('calendar-date');
                dateDiv.textContent = day;

                const fullDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
                const formattedDate = fullDate.toISOString().split('T')[0]; // YYYY-MM-DD

                // Check if there's an event on this date
                const hasEvent = events.some(event => event.date === formattedDate);
                if (hasEvent) {
                    dateDiv.classList.add('has-event');
                }

                dateDiv.addEventListener('click', () => {
                    const eventsOnThisDate = events.filter(e => e.date === formattedDate);
                    if (eventsOnThisDate.length > 0) {
                        const eventDetails = eventsOnThisDate.map(e => `${e.name}${e.description ? ` (${e.description})` : ''}`).join('\n');
                        window.showModal(`Event pada ${fullDate.toLocaleDateString('id-ID')}:\n${eventDetails}`);
                    } else {
                        window.showModal(`Tidak ada event pada ${fullDate.toLocaleDateString('id-ID')}.`);
                    }
                });

                calendarGrid.appendChild(dateDiv);
            }
        }

        prevMonthBtn.addEventListener('click', () => {
            console.log("Prev Month button clicked.");
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            console.log("Next Month button clicked.");
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });

        addEventBtn.addEventListener('click', async () => {
            console.log("Add Event button clicked.");
            const date = eventDateInput.value;
            const name = eventNameInput.value.trim();
            const description = eventDescriptionInput.value.trim();

            if (!date || !name) {
                window.showModal('Mohon masukkan tanggal dan nama event yang valid.');
                return;
            }
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap. Mohon tunggu atau coba lagi.');
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/events`), { // Changed path
                    date: date,
                    name: name,
                    description: description,
                    createdAt: new Date().toISOString()
                });
                eventDateInput.value = '';
                eventNameInput.value = '';
                eventDescriptionInput.value = '';
            } catch (e) {
                console.error("Error adding event: ", e);
                window.showModal('Gagal menambahkan event. Silakan coba lagi.');
            }
        });

        function renderEventList() {
            eventListDiv.innerHTML = '';
            if (events.length === 0) {
                eventListDiv.innerHTML = '<p class="text-gray-500">Belum ada event.</p>';
                return;
            }

            // Sort events by date ascending
            const sortedEvents = [...events].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedEvents.forEach((event) => {
                const eventItem = document.createElement('div');
                eventItem.classList.add('flex', 'justify-between', 'items-center', 'py-2', 'border-b', 'border-gray-200');
                eventItem.innerHTML = `
                    <div class="flex flex-col items-start">
                        <span class="font-medium text-gray-800">${event.name}</span>
                        <span class="text-xs text-gray-500">${new Date(event.date).toLocaleDateString('id-ID')}</span>
                        ${event.description ? `<span class="text-xs text-gray-500 italic">${event.description}</span>` : ''}
                    </div>
                    <button class="text-red-500 hover:text-red-700 text-sm" onclick="window.deleteEvent('${event.id}')">Hapus</button>
                `;
                eventListDiv.appendChild(eventItem);
            });
        }

        window.deleteEvent = async function(eventId) {
            console.log("Delete Event clicked:", eventId);
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap atau Anda tidak memiliki izin.');
                return;
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/events`, eventId)); // Changed path
            } catch (e) {
                console.error("Error deleting event: ", e);
                window.showModal('Gagal menghapus event. Silakan coba lagi.');
            }
        }

        // --- Habits Feature Logic ---
        function renderHabitsTable() {
            habitsTableBody.innerHTML = ''; // Clear previous entries
            if (habits.length === 0) {
                habitsTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Belum ada kebiasaan.</td>
                    </tr>
                `;
                return;
            }

            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

            habits.forEach((habit) => {
                const row = document.createElement('tr');
                const isCompletedToday = habit.completedDates && habit.completedDates[today];
                const completionCount = habit.completedDates ? Object.keys(habit.completedDates).length : 0;
                // Calculate total days since habit creation for a more accurate percentage
                const createdAtDate = new Date(habit.createdAt);
                const daysSinceCreation = Math.floor((new Date() - createdAtDate) / (1000 * 60 * 60 * 24));
                const progressPercentage = daysSinceCreation > 0 ? Math.round((completionCount / daysSinceCreation) * 100) : 0;
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${habit.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${progressPercentage}%;"></div>
                        </div>
                        <span class="text-xs text-gray-600">${progressPercentage}%</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600" ${isCompletedToday ? 'checked' : ''} onclick="window.toggleHabitCompletion('${habit.id}', event.target.checked)">
                        <span class="text-xs text-gray-500 ml-1">${isCompletedToday ? new Date().toLocaleDateString('id-ID') : ''}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900" onclick="window.deleteHabit('${habit.id}')">Hapus</button>
                    </td>
                `;
                habitsTableBody.appendChild(row);
            });
        }

        addHabitBtn.addEventListener('click', async () => {
            console.log("Add Habit button clicked.");
            const name = habitNameInput.value.trim();
            if (!name) {
                window.showModal('Mohon masukkan nama kebiasaan.');
                return;
            }
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap. Mohon tunggu atau coba lagi.');
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/habits`), { // Changed path
                    name: name,
                    completedDates: {}, // Store completion dates as a map
                    createdAt: new Date().toISOString() // Store creation date
                });
                habitNameInput.value = '';
            } catch (e) {
                console.error("Error adding habit: ", e);
                window.showModal('Gagal menambahkan kebiasaan. Silakan coba lagi.');
            }
        });

        window.toggleHabitCompletion = async function(habitId, isChecked) {
            console.log("Toggle Habit Completion clicked:", habitId, isChecked);
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap atau Anda tidak memiliki izin.');
                return;
            }
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const habitRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, habitId); // Changed path
            const habitToUpdate = habits.find(h => h.id === habitId);

            if (habitToUpdate) {
                const updatedCompletedDates = { ...habitToUpdate.completedDates };
                if (isChecked) {
                    updatedCompletedDates[today] = true;
                } else {
                    delete updatedCompletedDates[today];
                }

                try {
                    await updateDoc(habitRef, {
                        completedDates: updatedCompletedDates
                    });
                } catch (e) {
                    console.error("Error updating habit completion: ", e);
                    window.showModal('Gagal memperbarui status kebiasaan. Silakan coba lagi.');
                }
            }
        }

        window.deleteHabit = async function(habitId) {
            console.log("Delete Habit clicked:", habitId);
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap atau Anda tidak memiliki izin.');
                return;
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/habits`, habitId)); // Changed path
            } catch (e) {
                console.error("Error deleting habit: ", e);
                window.showModal('Gagal menghapus kebiasaan. Silakan coba lagi.');
            }
        }

        // --- Pic Drop Feature Logic (Simulated Upload) ---
        selectPhotoBtn.addEventListener('click', () => {
            console.log("Select Photo button clicked.");
            if (!isAuthReady || !userId) {
                window.showModal('Mohon login terlebih dahulu.');
                return;
            }
            photoUploadInput.click();
        });

        photoUploadInput.addEventListener('change', () => {
            console.log("Photo input changed.");
            if (photoUploadInput.files.length > 0) {
                uploadPhotoBtn.classList.remove('hidden');
            } else {
                uploadPhotoBtn.classList.add('hidden');
            }
        });

        uploadPhotoBtn.addEventListener('click', () => {
            console.log("Upload Photo button clicked.");
            const file = photoUploadInput.files[0];
            const caption = photoCaptionInput.value.trim();

            if (!file) {
                window.showModal('Mohon pilih foto untuk diunggah.');
                return;
            }

            // Simulate upload: In a real app, you'd upload this to Firebase Storage
            // For this demo, we'll just use a placeholder image and the caption
            const reader = new FileReader();
            reader.onload = (e) => {
                const simulatedImageUrl = e.target.result; // This is a Data URL (base64)
                uploadedPhotos.push({
                    src: simulatedImageUrl, // Using base64 for demo purposes
                    caption: caption || 'Kamera Upload Polaroid', // Mengubah nama ikon
                    date: new Date().toISOString()
                });
                renderPhotoGallery();
                
                // --- Pic Drop Camera Effect ---
                // Clear previous photo from camera frame
                cameraOutputFrame.innerHTML = ''; 
                const polaroid = document.createElement('div');
                polaroid.classList.add('polaroid-photo');
                polaroid.innerHTML = `
                    <img src="${simulatedImageUrl}" alt="${caption}">
                    <p>${caption || 'Kamera Upload Polaroid'}</p>
                `;
                cameraOutputFrame.appendChild(polaroid);

                photoCaptionInput.value = '';
                photoUploadInput.value = ''; // Clear the file input
                uploadPhotoBtn.classList.add('hidden');
                window.showModal('Foto berhasil diunggah (simulasi)!');
            };
            reader.readAsDataURL(file); // Read file as Data URL
        });

        function renderPhotoGallery() {
            photoGalleryDiv.innerHTML = ''; // Clear previous entries
            if (uploadedPhotos.length === 0) {
                photoGalleryDiv.innerHTML = '<p class="col-span-full text-gray-500 text-center">Belum ada foto.</p>';
                return;
            }

            // Sort photos by date descending
            const sortedPhotos = [...uploadedPhotos].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedPhotos.forEach((photo, index) => {
                const photoItem = document.createElement('div');
                photoItem.classList.add('relative', 'group', 'rounded-lg', 'overflow-hidden', 'shadow-md');
                photoItem.innerHTML = `
                    <img src="${photo.src}" alt="${photo.caption}" class="w-full h-32 object-cover rounded-lg">
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-lg">
                        <p class="text-white text-sm text-center px-2">${photo.caption}</p>
                        <button class="absolute top-2 right-2 text-white text-xl hover:text-red-400" onclick="window.deletePhoto(${index})">&times;</button>
                    </div>
                `;
                photoGalleryDiv.appendChild(photoItem);
            });
        }

        window.deletePhoto = function(index) {
            console.log("Delete Photo clicked:", index);
            uploadedPhotos.splice(index, 1);
            renderPhotoGallery();
            window.showModal('Foto berhasil dihapus.');
        }

        // --- Wishlist Feature Logic ---
        function renderWishlistItems() {
            wishlistItemsListDiv.innerHTML = ''; // Clear previous entries
            if (wishlistItems.length === 0) {
                wishlistItemsListDiv.innerHTML = '<p class="text-gray-500">Belum ada item di daftar keinginan.</p>';
                return;
            }

            wishlistItems.forEach((item) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('flex', 'justify-between', 'items-center', 'py-2', 'border-b', 'border-gray-200');
                const priceText = item.price ? ` (${formatCurrency(item.price)})` : '';
                const fulfilledClass = item.fulfilled ? 'line-through text-gray-500' : '';

                itemDiv.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" class="form-checkbox h-5 w-5 text-purple-600 mr-2" ${item.fulfilled ? 'checked' : ''} onclick="window.toggleWishlistItemFulfilled('${item.id}', event.target.checked)">
                        <span class="font-medium text-gray-800 ${fulfilledClass}">${item.name}${priceText}</span>
                    </div>
                    <button class="text-red-500 hover:text-red-700 text-sm" onclick="window.deleteWishlistItem('${item.id}')">Hapus</button>
                `;
                wishlistItemsListDiv.appendChild(itemDiv);
            });
        }

        addWishlistItemBtn.addEventListener('click', async () => {
            console.log("Add Wishlist Item button clicked.");
            const name = wishlistItemNameInput.value.trim();
            const price = parseFloat(wishlistItemPriceInput.value) || 0;

            if (!name) {
                window.showModal('Mohon masukkan nama item.');
                return;
            }
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap. Mohon tunggu atau coba lagi.');
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/wishlist`), { // Changed path
                    name: name,
                    price: price,
                    fulfilled: false,
                    createdAt: new Date().toISOString()
                });
                wishlistItemNameInput.value = '';
                wishlistItemPriceInput.value = '';
            } catch (e) {
                console.error("Error adding wishlist item: ", e);
                window.showModal('Gagal menambahkan item ke daftar keinginan. Silakan coba lagi.');
            }
        });

        window.toggleWishlistItemFulfilled = async function(itemId, isChecked) {
            console.log("Toggle Wishlist Item Fulfilled clicked:", itemId, isChecked);
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap atau Anda tidak memiliki izin.');
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const itemRef = doc(db, `artifacts/${appId}/users/${userId}/wishlist`, itemId); // Changed path
            try {
                await updateDoc(itemRef, {
                    fulfilled: isChecked
                });
            } catch (e) {
                console.error("Error updating wishlist item: ", e);
                window.showModal('Gagal memperbarui status item. Silakan coba lagi.');
            }
        }

        window.deleteWishlistItem = async function(itemId) {
            console.log("Delete Wishlist Item clicked:", itemId);
            if (!isAuthReady || !userId) {
                window.showModal('Aplikasi belum siap atau Anda tidak memiliki izin.');
                return;
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/wishlist`, itemId)); // Changed path
            } catch (e) {
                console.error("Error deleting wishlist item: ", e);
                window.showModal('Gagal menghapus item dari daftar keinginan. Silakan coba lagi.');
            }
        }

        // --- Dashboard Update Functions ---
        function updateDashboardFinance() {
            dashboardIncomeSpan.textContent = formatCurrency(totalIncome);
            dashboardExpenseSpan.textContent = formatCurrency(totalExpense);
            const balance = totalIncome - totalExpense;
            dashboardBalanceSpan.textContent = formatCurrency(balance);
            if (balance < 0) {
                dashboardBalanceSpan.classList.remove('text-indigo-700');
                dashboardBalanceSpan.classList.add('text-red-700');
            } else {
                dashboardBalanceSpan.classList.remove('text-red-700');
                dashboardBalanceSpan.classList.add('text-indigo-700');
            }
        }

        function updateDashboardSavings() {
            const activeGoals = savingGoals.length;
            const totalTarget = savingGoals.reduce((sum, goal) => sum + goal.targetAmount, 0);
            dashboardSavingGoalsSpan.textContent = activeGoals;
            dashboardTotalSavingTargetSpan.textContent = formatCurrency(totalTarget);
        }

        function updateDashboardHabits() {
            const activeHabits = habits.length;
            const today = new Date().toISOString().split('T')[0];
            const completedToday = habits.filter(h => h.completedDates && h.completedDates[today]).length;
            dashboardActiveHabitsSpan.textContent = activeHabits;
            dashboardCompletedHabitsSpan.textContent = completedToday;
        }

        function updateDashboardWishlist() {
            const activeItems = wishlistItems.length;
            const fulfilledItems = wishlistItems.filter(item => item.fulfilled).length;
            dashboardActiveWishlistSpan.textContent = activeItems;
            dashboardFulfilledWishlistSpan.textContent = fulfilledItems;
        }

        // --- Authentication Logic ---
        authToggleBtn.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                authTitle.textContent = 'Login';
                authSubtitle.textContent = 'Masuk untuk melanjutkan petualangan Anda!';
                authSubmitBtn.textContent = 'Login';
                authToggleBtn.textContent = 'Belum punya akun? Register';
            } else {
                authTitle.textContent = 'Register';
                authSubtitle.textContent = 'Daftar untuk memulai petualangan baru!';
                authSubmitBtn.textContent = 'Register';
                authToggleBtn.textContent = 'Sudah punya akun? Login';
            }
        });

        authSubmitBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            if (!email || !password) {
                window.showModal('Email dan password tidak boleh kosong.');
                return;
            }

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                    window.showModal('Login berhasil!');
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    window.showModal('Registrasi berhasil! Silakan login.');
                    isLoginMode = true; // Switch back to login mode after registration
                    authToggleBtn.click(); // Trigger UI update
                }
            } catch (error) {
                console.error("Authentication error:", error);
                let errorMessage = 'Terjadi kesalahan autentikasi.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email sudah terdaftar.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format email tidak valid.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password terlalu lemah (minimal 6 karakter).';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'Email atau password salah.';
                }
                window.showModal(errorMessage);
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.showModal('Anda telah logout.');
                // onAuthStateChanged will handle showing auth-page
            } catch (error) {
                console.error("Logout error:", error);
                window.showModal('Gagal logout. Silakan coba lagi.');
            }
        });

        // --- Profile Logic (formerly Couple Room Logic) ---
        // Toggle User ID visibility
        toggleUserIdBtn.addEventListener('click', () => {
            if (userIdDisplayContainer) {
                userIdDisplayContainer.classList.toggle('hidden');
            }
        });

        // Change user profile picture
        changeUserPicBtn.addEventListener('click', () => { // Renamed
            if (!isAuthReady || !userId) {
                window.showModal('Mohon login terlebih dahulu.');
                return;
            }
            userProfilePicUpload.click(); // Renamed
        });

        userProfilePicUpload.addEventListener('change', async () => { // Renamed
            if (userProfilePicUpload.files.length > 0) {
                const file = userProfilePicUpload.files[0];
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageUrl = e.target.result;
                    // For now, we'll just update the image source.
                    // In a real app, you'd upload this to Firebase Storage and save the URL to Firestore.
                    userProfilePic.src = imageUrl; // Renamed
                    headerUserProfilePic.src = imageUrl; // Update header icon
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                    try {
                        await setDoc(userProfileRef, { profilePicUrl: imageUrl }, { merge: true });
                        window.showModal('Foto profil berhasil diubah!');
                    } catch (e) {
                        console.error("Error updating profile picture:", e);
                        window.showModal('Gagal mengubah foto profil. Silakan coba lagi.');
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // Save user nickname
        saveUserNicknameBtn.addEventListener('click', async () => { // Renamed
            if (!isAuthReady || !userId) {
                window.showModal('Mohon login terlebih dahulu.');
                return;
            }
            const nickname = userNicknameInput.value.trim(); // Renamed
            if (!nickname) {
                window.showModal('Nama panggilan tidak boleh kosong.');
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
            try {
                await setDoc(userProfileRef, { nickname: nickname }, { merge: true });
                window.showModal('Nama panggilan berhasil disimpan!');
            } catch (e) {
                console.error("Error saving nickname:", e);
                window.showModal('Gagal menyimpan nama panggilan. Silakan coba lagi.');
            }
        });

        // Initial content load: show home page or auth page based on auth state
        window.addEventListener('load', () => {
            console.log("Window loaded.");
            // onAuthStateChanged will handle initial page display
            updateMonitorEventContentFromData(); // Initial call to populate Monitor Event
        });

        // Event Listeners for Footer Navigation (now navigate to specific pages)
        document.getElementById('dasbor-nav').addEventListener('click', () => {
            console.log("Dasbor nav clicked.");
            if (!isAuthReady) { window.showModal('Mohon login terlebih dahulu.'); return; }
            window.showPage('dasbor-page');
        });
        document.getElementById('kalender-nav').addEventListener('click', () => {
            console.log("Kalender nav clicked.");
            if (!isAuthReady) { window.showModal('Mohon login terlebih dahulu.'); return; }
            window.showPage('kalender-page');
        });
        document.getElementById('habits-nav').addEventListener('click', () => {
            console.log("Habits nav clicked.");
            if (!isAuthReady) { window.showModal('Mohon login terlebih dahulu.'); return; }
            window.showPage('habits-page');
        });
        document.getElementById('picdrop-nav').addEventListener('click', () => {
            console.log("Pic Drop nav clicked.");
            if (!isAuthReady) { window.showModal('Mohon login terlebih dahulu.'); return; }
            window.showPage('picdrop-page');
        });
        document.getElementById('wishlist-nav').addEventListener('click', () => {
            console.log("Wishlist nav clicked.");
            if (!isAuthReady) { window.showModal('Mohon login terlebih dahulu.'); return; }
            window.showPage('wishlist-page');
        });
    </script>
</body>
</html>
